var API_HOST="http://app.poll.dance",Player={loadTrack:function(n){DZ.player.playTracks([n])},pause:function(){DZ.player.pause()},play:function(){DZ.player.play()}},Controller={isInitialized:!1,roomId:null,isLoggedIn:!1,currentTrack:null,initialized:function(){return this.isInitialized},roomSet:function(){return null!==this.roomId},loggedIn:function(){return this.isLoggedIn},playing:function(){return Player.playing()},fetchingNext:!1,init:function(){var n=this;console.log("initializing controller"),DZ.init({appId:"133181",channelUrl:"http://"+window.location.host+"/channel.html",player:{playlist:!1,onload:function(){DZ.Event.subscribe("track_end",function(){console.log("track end triggered"),n.loadNextTrack()}),n.isInitialized=!0,View.showLanding()}}})},setRoom:function(n,o,i,t){var e=this;$.ajax({url:API_HOST+"/room",method:"POST",data:{code:n},dataType:"json",success:function(n){e.roomId=n.id,View.showLogin(),o()},error:function(n){return console.log(n),409===n.status?(e.roomId=n.responseJSON.id,void i()):void t("An error happened : "+n.responseText)}})},login:function(){console.log("logging in...");var n=this;DZ.login(function(o){o.authResponse?(console.log("Welcome!  Fetching your information.... "),DZ.api("/user/me",function(o){console.log("Good to see you, "+o.name+"."),n.isLoggedIn=!0,View.showPlayer()})):console.log("User cancelled login or did not fully authorize.")},{perms:"manage_library,delete_library"})},play:function(){this.currentTrack?(Player.play(),View.setPlaying()):this.loadNextTrack()},pause:function(){Player.pause(),View.setPaused()},loadNextTrack:function(){var n=this;$.ajax({url:API_HOST+"/room/"+this.roomId+"/top",type:"DELETE",success:function(o){Player.loadTrack(o.id),n.currentTrack=o,View.updateTrack(o),View.setPlaying()},error:function(n){404===n.status&&alert("The playlist is empty :(  Follow the instructions on the right to add some tracks and try again.")}})}},View={init:function(){console.log("initializing view"),this.joinRoomCont=$("#joinroom, #menu-joinroom"),this.joinRoomSpinner=$("#joinroom .upvote"),this.loginCont=$("#login, #menu-login"),this.playingCont=$("#playing, #menu-playing"),this.currentTrackCont=$("#playing .current"),this.conflictCont=$("#conflict");var n=this;this.loginCont.find("a").on("click",function(){Controller.login()}),this.playingCont.find("#play").on("click",function(){Controller.play()}),this.playingCont.find("#pause").on("click",function(){Controller.pause()}),this.playingCont.find("#next").on("click",function(){Controller.loadNextTrack()}),this.playingCont.find("#app_link").on("click",function(n){n.preventDefault(),window.open($(this).attr("href"),"poll.dance","scrollbars=yes,width=640,height=960")}),this.joinRoomCont.on("click",function(){n.joinRoomCont.addClass("focus"),n.joinRoomSpinner.removeClass("muted")}),this.joinRoomCont.find("form").on("submit",function(o){o.preventDefault(),n.joinRoomSpinner.addClass("spin");var i=n.joinRoomCont.find("input").val();Controller.setRoom(i,function(){n.joinRoomSpinner.removeClass("spin"),$(".code").html(i)},function(){n.conflictCont.fadeIn("slow")},function(o){n.joinRoomSpinner.removeClass("spin"),alert("Error : "+o)})}),$("#choose-other-code").on("click",function(){$("#conflict").hide(),$("#access_code").val(null).focus()}),$("#continue-with-code").on("click",function(){var n=$("#access_code").val();$(".code").html(n),View.showLogin()}),this.playingCont.find("#pause").hide(),this.conflictCont.hide(),$("#container").show()},showLanding:function(){$(".step").removeClass("active"),$(".step-room-login").addClass("active")},showLogin:function(){$(".step").removeClass("active"),$(".step-deezer-login").addClass("active")},showPlayer:function(){$(".step").removeClass("active"),$(".step-player").addClass("active")},updateTrack:function(n){this.currentTrackCont.find(".artist").html(n.artist),this.currentTrackCont.find(".title").html(n.title)},setPlaying:function(){this.playingCont.find("#play").hide(),this.playingCont.find("#pause").show()},setPaused:function(){this.playingCont.find("#pause").hide(),this.playingCont.find("#play").show()}};View.init(),Controller.init();